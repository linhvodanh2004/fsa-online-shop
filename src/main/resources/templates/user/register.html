<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <title>Register</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="apple-touch-icon" href="/user/img/apple-icon.png">
    <link rel="shortcut icon" type="image/x-icon" href="/user/img/favicon.ico">

    <link rel="stylesheet" href="/user/css/bootstrap.min.css">
    <link rel="stylesheet" href="/user/css/templatemo.css">
    <link rel="stylesheet" href="/user/css/custom.css">

    <!-- Load fonts style after rendering the layout styles -->
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;200;300;400;500;700;900&display=swap">
    <link rel="stylesheet" href="/user/css/fontawesome.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
</head>
<body>
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-md-7 d-none d-lg-block login-bg">
            <div class="login-bg-content">
                <div>
                    <h1>Inspirational gaming setup</h1>
                    <a class="btn btn-outline-light btn-lg" href="/">Homepage</a>
                    <a class="btn btn-primary btn-lg" href="/login">Login</a>
                </div>
            </div>
        </div>
        <div class="col-xs-12 col-sm-12 col-md-5 col-lg-5 col-xl-5 mt-3">
            <!--            <h3 class="text-center mb-4 mt-3">Create New Account</h3>-->
            <a class="navbar-brand text-success logo h1 align-self-center d-flex justify-content-center"
               th:href="@{/}">
                GOS
            </a>
            <form id="registerForm" method="post" th:action="@{/register}">
                <div class="mb-2">
                    <label class="form-label">Username<span class="text-danger">*</span></label>
                    <input class="form-control form-control-lg" type="text" name="username" id="username"
                           placeholder="Enter username"/>
                    <div id="username-error" class="text-danger mt-1" style="display: none;"></div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Password<span class="text-danger">*</span></label>
                    <input class="form-control form-control-lg" type="password" name="password" id="password"
                           placeholder="Enter password"/>
                    <div id="password-error" class="text-danger mt-1" style="display: none;"></div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Confirm password<span class="text-danger">*</span></label>
                    <input class="form-control form-control-lg" type="password" name="confirm-password"
                           id="confirm-password"
                           placeholder="Confirm password"/>
                    <div id="confirm-password-error" class="text-danger mt-1" style="display: none;"></div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Fullname</label>
                    <input class="form-control form-control-lg" type="text" name="fullname"
                           placeholder="Enter fullname"/>
                </div>
                <div class="mb-3">
                    <label class="form-label">Email<span class="text-danger">*</span></label>
                    <input class="form-control form-control-lg" type="text" name="email" id="email"
                           placeholder="Enter email"/>
                    <div id="email-error" class="text-danger mt-1" style="display: none;"></div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Phone</label>
                    <input class="form-control form-control-lg" type="text" name="phone" id="phone"
                           placeholder="Enter phone number"/>
                    <div id="phone-error" class="text-danger mt-1" style="display: none;"></div>
                </div>

                <div class="text-center mt-2">
                    <button type="submit" id="register-btn" class="btn btn-lg btn-success">Register now</button>
                    <br>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- GOS Chat Widget Component -->
<div th:replace="~{component/chat-widget :: chat-widget('shop', 'üõí', 'GOS Shop Support', '‚óè T∆∞ v·∫•n mua s·∫Øm', 'üõí <strong>Ch√†o m·ª´ng ƒë·∫øn GOS Shop!</strong><br>T√¥i c√≥ th·ªÉ gi√∫p b·∫°n:<br>‚Ä¢ T√¨m s·∫£n ph·∫©m ph√π h·ª£p<br>‚Ä¢ So s√°nh gi√° c·∫£<br>‚Ä¢ Th√¥ng tin khuy·∫øn m√£i<br>‚Ä¢ H·ªó tr·ª£ ƒë·∫∑t h√†ng<br><br>B·∫°n ƒëang t√¨m s·∫£n ph·∫©m g√¨? üòä')}"></div>

<!-- Start Script -->
<script src="/user/js/jquery-1.11.0.min.js"></script>
<script src="/user/js/jquery-migrate-1.2.1.min.js"></script>
<script src="/user/js/bootstrap.bundle.min.js"></script>
<script src="/user/js/templatemo.js"></script>
<script src="/user/js/custom.js"></script>
<!-- End Script -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script src="/toastify-message.js"></script>
<script>
    // Validation state
    let validationState = {
        username: false,
        email: false,
        password: false,
        'confirm-password': false,
        phone: true // Phone is optional, so default to true
    };

    // Field required state
    let fieldValues = {
        username: '',
        email: '',
        password: '',
        'confirm-password': ''
    };

    // Debounce function to avoid too many API calls
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Show error message
    function showError(fieldId, message) {
        const errorDiv = document.getElementById(fieldId + '-error');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        validationState[fieldId] = false;
        updateRegisterButton();
    }

    // Hide error message
    function hideError(fieldId) {
        const errorDiv = document.getElementById(fieldId + '-error');
        errorDiv.style.display = 'none';
        validationState[fieldId] = true;
        updateRegisterButton();
    }

    // Update register button state
    function updateRegisterButton() {
        const registerBtn = document.getElementById('register-btn');

        // Check if all required fields have values (excluding optional phone)
        const requiredFields = {
            username: fieldValues.username,
            email: fieldValues.email,
            password: fieldValues.password,
            'confirm-password': fieldValues['confirm-password']
        };
        const allRequiredFieldsFilled = Object.values(requiredFields).every(value => value.trim() !== '');

        // Check if all validations passed
        const allValidationsPassed = Object.values(validationState).every(valid => valid);

        const shouldEnable = allRequiredFieldsFilled && allValidationsPassed;

        registerBtn.disabled = !shouldEnable;
        registerBtn.style.opacity = shouldEnable ? '1' : '0.6';
        registerBtn.style.cursor = shouldEnable ? 'pointer' : 'not-allowed';
    }

    // Update field value and button state
    function updateFieldValue(fieldName, value) {
        fieldValues[fieldName] = value;
        updateRegisterButton();
    }

    // Check username availability
    const checkUsername = debounce(async (username) => {
        if (!username || username.length < 6) {
            if (username && username.length < 6) {
                showError('username', 'Username must be at least 6 characters');
            }
            return;
        }

        if (
            username.startsWith("google_user_") ||
            /\s/.test(username) // checks for any whitespace character
        ) {
            showError('username', 'Username cannot contain whitespace');
            return;
        }


        try {
            const response = await fetch(`/api/validation/check-username?username=${encodeURIComponent(username)}`);
            const data = await response.json();

            if (data.exists) {
                showError('username', data.message);
            } else {
                hideError('username');
            }
        } catch (error) {
        }
    }, 500);

    // Check email availability
    const checkEmail = debounce(async (email) => {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

        if (!email) {
            return;
        }

        if (!emailRegex.test(email)) {
            showError('email', 'Invalid email format');
            return;
        }

        try {
            const response = await fetch(`/api/validation/check-email?email=${encodeURIComponent(email)}`);
            const data = await response.json();

            if (data.exists) {
                showError('email', data.message);
            } else {
                hideError('email');
            }
        } catch (error) {
        }
    }, 500);

    // Check phone availability
    const checkPhone = debounce(async (phone) => {
        if (!phone || phone.trim() === '') {
            hideError('phone'); // Phone is optional
            return;
        }

        const phoneRegex = /^\+?\d{10,15}$/;
        if (!phoneRegex.test(phone)) {
            showError('phone', 'Invalid phone number format');
            return;
        }

        try {
            const response = await fetch(`/api/validation/check-phone?phone=${encodeURIComponent(phone)}`);
            const data = await response.json();

            if (data.exists) {
                showError('phone', data.message);
            } else {
                hideError('phone');
            }
        } catch (error) {
        }
    }, 500);

    // Validate password
    const validatePassword = debounce((password) => {
        if (!password || password.trim() === '') {
            // Hide error message but keep state invalid. The disabled button is enough feedback.
            const errorDiv = document.getElementById('password-error');
            errorDiv.style.display = 'none';
            validationState['password'] = false;
            updateRegisterButton();
            return;
        }

        // Password regex: at least 8 characters, 1 lowercase, 1 uppercase, 1 digit, 1 special character
        const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&^#])[A-Za-z\d@$!%*?&^#]{8,}$/;

        if (passwordRegex.test(password)) {
            hideError('password');
        } else {
            showError('password', 'Password must be at least 8 characters with uppercase, lowercase, number and special character');
        }
    }, 500);

    // Validate confirm password
    const validateConfirmPassword = debounce((password, confirmPassword) => {
        if (!confirmPassword || confirmPassword.trim() === '') {
            const errorDiv = document.getElementById('confirm-password-error');
            errorDiv.style.display = 'none';
            validationState['confirm-password'] = false;
            updateRegisterButton();
            return;
        }

        if (password.trim() === confirmPassword.trim()) {
            hideError('confirm-password');
        } else {
            showError('confirm-password', 'Passwords do not match');
        }
    }, 500);

    // Add event listeners
    document.getElementById('username').addEventListener('blur', function () {
        checkUsername(this.value.trim());
    });

    document.getElementById('username').addEventListener('input', function () {
        updateFieldValue('username', this.value);
    });

    document.getElementById('email').addEventListener('blur', function () {
        checkEmail(this.value.trim());
    });

    document.getElementById('email').addEventListener('input', function () {
        updateFieldValue('email', this.value);
    });

    document.getElementById('password').addEventListener('blur', function () {
        validatePassword(this.value.trim());
    });

    document.getElementById('password').addEventListener('input', function () {
        updateFieldValue('password', this.value);
        // Also revalidate confirm password when password changes
        const confirmPassword = document.getElementById('confirm-password').value;
        if (confirmPassword) {
            validateConfirmPassword(this.value.trim(), confirmPassword.trim());
        }
    });

    document.getElementById('confirm-password').addEventListener('blur', function () {
        const password = document.getElementById('password').value;
        validateConfirmPassword(password.trim(), this.value.trim());
    });

    document.getElementById('confirm-password').addEventListener('input', function () {
        updateFieldValue('confirm-password', this.value);
        const password = document.getElementById('password').value;
        validateConfirmPassword(password.trim(), this.value.trim());
    });

    document.getElementById('phone').addEventListener('blur', function () {
        checkPhone(this.value.trim());
    });

    // Form submission
    document.getElementById("registerForm").addEventListener("submit", function (e) {
        // If button is disabled, prevent submission
        const registerBtn = document.getElementById('register-btn');
        if (registerBtn.disabled) {
            e.preventDefault();
        }

        // If all validations pass, allow form submission
        // No need for additional validation here since button is only enabled when all validations pass
    });

    // Initialize button state
    updateRegisterButton();
</script>
</body>
</html>