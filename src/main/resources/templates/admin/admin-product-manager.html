<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
	  xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta name="description" content="Responsive Admin &amp; Dashboard Template based on Bootstrap 5">
	<meta name="author" content="AdminKit">
	<meta name="keywords"
		content="adminkit, bootstrap, bootstrap 5, admin, dashboard, template, responsive, css, sass, html, theme, front-end, ui kit, web">

	<link rel="preconnect" href="https://fonts.gstatic.com">
	<link rel="shortcut icon" href="/admin/img/icons/icon-48x48.png" />

	<link rel="canonical" href="#" />

	<title>Product Manager | Admin</title>

	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&amp;display=swap" rel="stylesheet">

	<!-- Choose your prefered color scheme -->
	<link href="/admin/css/light.css" rel="stylesheet">
	<!-- <link href="css/dark.css" rel="stylesheet"> -->

	<!-- BEGIN SETTINGS -->
	<!-- Remove this after purchasing -->
	<link class="js-stylesheet" href="/admin/css/light.css" rel="stylesheet">
	<script src="/admin/js/settings.js"></script>
	<style>
		body {
			opacity: 0;
		}
	</style>
	<!-- END SETTINGS -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-120946860-10"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag() { dataLayer.push(arguments); }
		gtag('js', new Date());

		gtag('config', 'UA-120946860-10', { 'anonymize_ip': true });
	</script>

	<style>
		.opacity-50 {
			opacity: 0.5;
		}

		.addrow:hover {
			background-color: #dddddd;
			cursor: pointer;
		}
	</style>
	<script src="/admin/js/active-nav.js"></script>

</head>
<!--
  HOW TO USE:
  data-theme: default (default), dark, light, colored
  data-layout: fluid (default), boxed
  data-sidebar-position: left (default), right
  data-sidebar-layout: default (default), compact
-->

<body data-theme="default" data-layout="fluid" data-sidebar-position="left" data-sidebar-layout="default">
	<div class="wrapper">
		<div th:replace="~{component/admin-sidebar :: admin-sidebar}"></div>

		<div class="main">
			<div th:replace="~{component/admin-navbar :: admin-navbar}"></div>

			<main class="content">
				<div class="container-fluid p-0">
					<div class="row">
						<div class="col-12">
							<div class="card">
								<div class="card-header">
									<h5 class="card-title" style="color: black; font-size: 23px;">Product List</h5>
								</div>
								<div class="card-body">
									<div class="mb-3 d-flex justify-content-start">
										<select id="sortSelect" class="form-select form-select-sm w-auto ms-2"
											style="font-size: 16px; min-width: 180px;">
											<option value="">Sort by</option>
											<option value="price-asc">Price ↑</option>
											<option value="price-desc">Price ↓</option>
											<option value="quantity-asc">Quantity ↑</option>
											<option value="quantity-desc">Quantity ↓</option>
										</select>
										<div class="ms-auto">
											<button type="button" class="btn btn-primary"
												onclick="location.href='/admin/products/add';">
												<i data-feather="plus"></i> Add New Product
											</button>
										</div>
									</div>
									<div th:if="${#lists.isEmpty(products)}">
										<div th:replace="~{component/no-item-notification :: no-item-notification}">
										</div>
									</div>
									<table id="datatables-column-search-text-inputs" class="table"
										style="width:100%; text-align: center;"
										th:if="${products != null and !#lists.isEmpty(products)}">
										<thead>
											<tr>
												<th>Image</th>
												<th>Name</th>
												<th>Category</th>
												<th>Price</th>
												<th>Quantity</th>
												<th>Sold</th>
												<th>Status</th>
												<th>Action</th>
											</tr>
										</thead>
										<tbody>
											<tr th:each="product : ${products}"
												th:classappend="${product.status == null or !product.status} ? 'opacity-50'">
												<td>
													<img th:src="${product.image}" alt="Product Image"
														style="width: 120px; height: 120px; object-fit: cover;">
												</td>
												<td th:text="${product.name}"></td>
												<td th:text="${product.category.name}"></td>
												<td th:text="${#numbers.formatDecimal(product.price, 1, 'COMMA', 0, 'POINT')} + ' VND'"></td>
												<td th:text="${product.quantity}"></td>
												<td th:text="${product.sold}"></td>
												<td>
													<span class="align-middle" onclick="event.stopPropagation();">
														<i class="align-middle" th:if="${product.status}"
															data-feather="toggle-right"
															style="cursor:pointer; color: green;"
															th:attr="data-id=${product.id}, data-status=${product.status}"
															onclick="toggleProductStatus(this)">
														</i>
														<i class="align-middle" th:unless="${product.status}"
															data-feather="toggle-left"
															style="cursor:pointer; color: red;"
															th:attr="data-id=${product.id}, data-status=${product.status}"
															onclick="toggleProductStatus(this)">
														</i>
													</span>
												</td>
												<td>
													<button class="btn btn-link text-decoration-none" type="button"
															th:onclick="'location.href=\'/admin/products/update/' + ${product.id} + '\';'">
														<i class="align-middle text-primary" data-feather="edit-2"></i>
													</button>
												</td>
											</tr>
										</tbody>
									</table>

									<div id="pagination" class="mt-3">
										<nav th:if="${totalPages > 1}">
											<ul class="pagination mb-0">
												<li class="page-item" th:classappend="${page == 0} ? 'disabled'">
													<a class="page-link"
													   th:href="@{/admin/products(page=${page-1},size=${size},sortBy=${sortBy},direction=${direction})}">Previous</a>
												</li>
												<li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages-1)}"
													th:classappend="${i == page} ? 'active'">
													<a class="page-link"
													   th:href="@{/admin/products(page=${i},size=${size},sortBy=${sortBy},direction=${direction})}"
													   th:text="${i+1}"></a>
												</li>
												<li class="page-item" th:classappend="${page == totalPages-1} ? 'disabled'">
													<a class="page-link"
													   th:href="@{/admin/products(page=${page+1},size=${size},sortBy=${sortBy},direction=${direction})}">Next</a>
												</li>
											</ul>
										</nav>
									</div>
								</div>
							</div>
						</div>


					</div>
				</div>


			</main>
			<div th:replace="~{component/admin-footer :: admin-footer}"></div>

		</div>
	</div>


	<script src="/admin/js/app.js"></script>

	<script src="/admin/js/datatables.js"></script>
	<script src="https://unpkg.com/feather-icons"></script>
	<script>
		document.addEventListener("DOMContentLoaded", function () {
			if (window.feather) {
				feather.replace();
			}
		});
	</script>

<!--Update product status script-->
	<script>
		function updateRowOpacity(icon, newStatus) {
			const row = icon.closest('tr');
			if (!newStatus) {
				row.classList.add('opacity-50');
			} else {
				row.classList.remove('opacity-50');
			}
		}

		function toggleProductStatus(icon) {
			const currentStatus = icon.getAttribute('data-status') === 'true';
			const productId = icon.getAttribute('data-id');
			const newStatus = !currentStatus;

			updateRowOpacity(icon, newStatus);

			// Get CSRF token and header name from meta tags
			// const csrfTokenMeta = document.querySelector('meta[name="_csrf"]');
			// const csrfHeaderMeta = document.querySelector('meta[name="_csrf_header"]');
			// const csrfToken = csrfTokenMeta ? csrfTokenMeta.getAttribute('content') : null;
			// const csrfHeader = csrfHeaderMeta ? csrfHeaderMeta.getAttribute('content') : null;

			// Build headers object
			const headers = {
				'Content-Type': 'application/json'
			};
			// if (csrfHeader && csrfToken && csrfHeader !== 'null' && csrfHeader !== 'undefined') {
			// 	headers[csrfHeader] = csrfToken;
			// }

			fetch(`/admin/products/${productId}/status`, {
				method: 'POST',
				headers: headers,
				body: JSON.stringify({ status: newStatus })
			})
				.then(response => {
					if (!response.ok) throw new Error('Failed to update status');
					// Update icon and data-status without reload
					icon.setAttribute('data-status', newStatus);
					if (newStatus) {
						icon.setAttribute('data-feather', 'toggle-right');
						icon.style.color = 'green';
					} else {
						icon.setAttribute('data-feather', 'toggle-left');
						icon.style.color = 'red';
					}
					if (window.feather) feather.replace();
				})
				.catch(error => {
					alert('Error updating status!');
					console.error(error);
					updateRowOpacity(icon, currentStatus);
				});
		}
	</script>
	<!-- table sort script -->
	<script>
		function updateProductList(params) {
			const url = new URL(window.location.href);
			Object.keys(params).forEach(key => url.searchParams.set(key, params[key]));
			window.location.href = url.toString();
		}
		document.getElementById('sortSelect').addEventListener('change', function () {
			const value = this.value;
			let sortBy = 'price', direction = 'asc';
			if (value === 'price-desc') { sortBy = 'price'; direction = 'desc'; }
			else if (value === 'price-asc') { sortBy = 'price'; direction = 'asc'; }
			else if (value === 'quantity-desc') { sortBy = 'quantity'; direction = 'desc'; }
			else if (value === 'quantity-asc') { sortBy = 'quantity'; direction = 'asc'; }
			updateProductList({ sortBy, direction, page: 0 });
		});

	</script>
	<!-- Search box script -->
	<script>
		document.getElementById('productSearchBox').addEventListener('keyup', function (e) {
			if (e.key === 'Enter') {
				const query = this.value.trim();
				const url = new URL(window.location.href);
				url.searchParams.set('search', query);
				url.searchParams.set('page', 0); // Reset to first page
				window.location.href = url.toString();
			}
		});
	</script>
</body>

</html>