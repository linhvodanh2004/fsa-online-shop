<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<!-- Reusable Chat Widget Component -->
<div th:fragment="chat-widget(pageType, icon, title, subtitle, welcomeMessage)">
    <!-- GOS Chat Widget -->
    <div id="gosChatWidget" style="position: fixed; bottom: 20px; right: 20px; z-index: 99999; font-family: Arial, sans-serif;">
        <!-- Chat Toggle Button -->
        <button id="gosChatToggle" style="
            width: 60px; height: 60px; border-radius: 50%;
            background: linear-gradient(135deg, #28a745, #1e7e34);
            color: white; border: none; font-size: 24px; cursor: pointer;
            box-shadow: 0 4px 12px rgba(40,167,69,0.4);
            display: flex; align-items: center; justify-content: center;
            transition: all 0.3s ease;
        " onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
            üí¨
        </button>

        <!-- Chat Window -->
        <div id="gosChatWindow" style="
            display: none; position: absolute; bottom: 70px; right: 0;
            width: 350px; height: 500px; background: white; border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15); overflow: hidden; border: 2px solid #28a745;
        ">
            <!-- Chat Header -->
            <div style="
                background: linear-gradient(135deg, #28a745, #1e7e34); color: white; padding: 15px;
                display: flex; justify-content: space-between; align-items: center;
            ">
                <div style="display: flex; align-items: center;">
                    <div style="
                        width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 50%;
                        display: flex; align-items: center; justify-content: center; margin-right: 10px; font-size: 18px;
                    " th:text="${icon ?: 'üéÆ'}"></div>
                    <div>
                        <h4 style="margin: 0; font-size: 16px; font-weight: bold;" th:text="${title ?: 'GOS Gaming Support'}"></h4>
                        <span id="connectionStatus" style="font-size: 12px; opacity: 0.8;" th:text="${subtitle ?: '‚óè Tr·ª±c tuy·∫øn'}"></span>
                    </div>
                </div>
                <button id="gosChatClose" style="
                    background: none; border: none; color: white; font-size: 20px; cursor: pointer;
                    padding: 5px; border-radius: 50%; width: 30px; height: 30px;
                    display: flex; align-items: center; justify-content: center;
                " onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='none'">‚úï</button>
            </div>

            <!-- Chat Messages -->
            <div id="gosChatMessages" style="height: 350px; overflow-y: auto; padding: 15px; background: #f8f9fa;">
                <div style="margin-bottom: 15px;">
                    <div style="
                        max-width: 80%; padding: 12px 16px; border-radius: 18px; background: white; color: #333;
                        border-bottom-left-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        font-size: 14px; line-height: 1.4; border-left: 3px solid #28a745;
                    " th:utext="${welcomeMessage ?: 'üéÆ <strong>Ch√†o m·ª´ng ƒë·∫øn GOS Gaming!</strong><br>T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n? üòä'}"></div>
                    <div style="font-size: 11px; color: #999; margin-top: 5px; padding: 0 15px;">V·ª´a xong</div>
                </div>
            </div>

            <!-- Chat Input -->
            <div style="padding: 15px; border-top: 1px solid #eee; display: flex; gap: 10px; background: white;">
                <input type="text" id="gosChatInput" placeholder="Nh·∫≠p tin nh·∫Øn c·ªßa b·∫°n..." style="
                    flex: 1; padding: 12px 16px; border: 2px solid #e9ecef; border-radius: 25px;
                    outline: none; font-size: 14px; transition: border-color 0.2s ease;
                " onfocus="this.style.borderColor='#28a745'" onblur="this.style.borderColor='#e9ecef'">
                <button id="gosChatSend" style="
                    width: 45px; height: 45px; border-radius: 50%; background: #28a745; color: white;
                    border: none; cursor: pointer; font-size: 18px; display: flex;
                    align-items: center; justify-content: center; transition: background 0.2s ease;
                " onmouseover="this.style.background='#1e7e34'" onmouseout="this.style.background='#28a745'">‚û§</button>
            </div>

            <!-- Loading Indicator -->
            <div id="gosLoadingIndicator" style="
                display: none; position: absolute; bottom: 80px; left: 15px;
                background: white; padding: 8px 12px; border-radius: 15px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1); font-size: 12px; color: #666;
            ">
                <span>‚óè</span> <span>‚óè</span> <span>‚óè</span> GOS Assistant ƒëang so·∫°n tin...
                <style>
                    #gosLoadingIndicator span {
                        animation: pulse 1.4s ease-in-out infinite both;
                    }
                    #gosLoadingIndicator span:nth-child(1) { animation-delay: -0.32s; }
                    #gosLoadingIndicator span:nth-child(2) { animation-delay: -0.16s; }
                    @keyframes pulse {
                        0%, 80%, 100% { opacity: 0.3; }
                        40% { opacity: 1; }
                    }
                </style>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Chat widget elements
            const chatWidget = document.getElementById('gosChatWidget');
            const chatToggle = document.getElementById('gosChatToggle');
            const chatWindow = document.getElementById('gosChatWindow');
            const chatClose = document.getElementById('gosChatClose');
            const chatMessages = document.getElementById('gosChatMessages');
            const chatInput = document.getElementById('gosChatInput');
            const chatSend = document.getElementById('gosChatSend');
            const loadingIndicator = document.getElementById('gosLoadingIndicator');
            const connectionStatus = document.getElementById('connectionStatus');

            // API endpoint - adjust this to match your server
            const CHAT_API_URL = '/api/chat/message';

            let isLoading = false;

            // Toggle chat window
            function toggleChat() {
                const isVisible = chatWindow.style.display !== 'none';
                chatWindow.style.display = isVisible ? 'none' : 'block';

                if (!isVisible) {
                    chatInput.focus();
                }
            }

            // Add message to chat
            function addMessage(message, isUser = false, timestamp = null) {
                const messageDiv = document.createElement('div');
                messageDiv.style.cssText = 'margin-bottom: 15px;';

                const time = timestamp ? new Date(timestamp).toLocaleTimeString('vi-VN', {
                    hour: '2-digit',
                    minute: '2-digit'
                }) : new Date().toLocaleTimeString('vi-VN', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                if (isUser) {
                    messageDiv.innerHTML = `
                        <div style="display: flex; justify-content: flex-end;">
                            <div style="
                                max-width: 80%; padding: 12px 16px; border-radius: 18px;
                                background: linear-gradient(135deg, #28a745, #1e7e34); color: white;
                                border-bottom-right-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                                font-size: 14px; line-height: 1.4;
                            ">${escapeHtml(message)}</div>
                        </div>
                        <div style="font-size: 11px; color: #999; margin-top: 5px; padding: 0 15px; text-align: right;">${time}</div>
                    `;
                } else {
                    messageDiv.innerHTML = `
                        <div style="
                            max-width: 80%; padding: 12px 16px; border-radius: 18px; background: white; color: #333;
                            border-bottom-left-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                            font-size: 14px; line-height: 1.4; border-left: 3px solid #28a745;
                        ">${message}</div>
                        <div style="font-size: 11px; color: #999; margin-top: 5px; padding: 0 15px;">${time}</div>
                    `;
                }

                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // Escape HTML to prevent XSS
            function escapeHtml(unsafe) {
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            // Show/hide loading indicator
            function setLoading(loading) {
                isLoading = loading;
                loadingIndicator.style.display = loading ? 'block' : 'none';
                chatSend.disabled = loading;
                chatSend.style.opacity = loading ? '0.6' : '1';
                chatSend.style.cursor = loading ? 'not-allowed' : 'pointer';

                if (loading) {
                    connectionStatus.textContent = '‚óè ƒêang ph·∫£n h·ªìi...';
                } else {
                    connectionStatus.textContent = '‚óè Tr·ª±c tuy·∫øn';
                }
            }

            // Send message to AI
            async function sendMessage(message) {
                if (!message.trim() || isLoading) return;

                // Add user message to chat
                addMessage(message, true);
                chatInput.value = '';
                setLoading(true);

                try {
                    const response = await fetch(CHAT_API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: message
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Add AI response to chat
                        addMessage(data.message, false, data.timestamp);
                    } else {
                        // Handle error response
                        addMessage(
                            data.message || 'Xin l·ªói, ƒë√£ c√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i sau.',
                            false
                        );
                    }
                } catch (error) {
                    console.error('Chat API Error:', error);
                    addMessage(
                        '‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng v√† th·ª≠ l·∫°i.',
                        false
                    );
                    connectionStatus.textContent = '‚óè M·∫•t k·∫øt n·ªëi';
                } finally {
                    setLoading(false);
                }
            }

            // Event listeners
            chatToggle.addEventListener('click', toggleChat);
            chatClose.addEventListener('click', toggleChat);

            chatSend.addEventListener('click', () => {
                sendMessage(chatInput.value);
            });

            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage(chatInput.value);
                }
            });

            // Auto-resize input on focus
            chatInput.addEventListener('focus', () => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });

            // Test connection on load
            setTimeout(async () => {
                try {
                    const response = await fetch(CHAT_API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: 'test connection'
                        })
                    });

                    if (!response.ok) {
                        connectionStatus.textContent = '‚óè Offline';
                        connectionStatus.style.opacity = '0.6';
                    }
                } catch (error) {
                    connectionStatus.textContent = '‚óè Offline';
                    connectionStatus.style.opacity = '0.6';
                }
            }, 1000);
        });
    </script>
</div>

</html>